<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRT's Wiki</title>
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1057417.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root {
            --md-primary-fg-color: #3f51b5;
            --md-text-color: #333;
            --sidebar-width: 280px;
            --header-height: 54px;
        }

        /* åŸºç¡€å¸ƒå±€ */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', 'Noto Sans SC', sans-serif; background: #fdfdfd; line-height: 1.6; }

        /* å¯¼èˆªå¤´ */
        .header { background: var(--md-primary-fg-color); color: white; height: var(--header-height); display: flex; align-items: center; padding: 0 24px; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-title { font-size: 1.2rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .auth-zone { margin-left: auto; }

        /* å†…å®¹å¸ƒå±€ */
        .container { display: flex; margin-top: var(--header-height); max-width: 1400px; margin-left: auto; margin-right: auto; width: 100%; min-height: calc(100vh - var(--header-height)); }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: var(--sidebar-width); background: #f8f9fb; border-right: 1px solid #eee; position: sticky; top: var(--header-height); height: calc(100vh - var(--header-height)); overflow-y: auto; padding: 20px 0; }
        .nav-group-title { padding: 8px 24px; color: #999; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .nav-item { display: block; padding: 10px 24px; color: var(--md-text-color); text-decoration: none; font-size: 0.95rem; cursor: pointer; border-left: 4px solid transparent; }
        .nav-item:hover { background: #eee; }
        .nav-item.active { color: var(--md-primary-fg-color); border-left-color: var(--md-primary-fg-color); background: #e8eaf6; font-weight: 600; }

        /* ä¸»å†…å®¹ */
        .main-content { flex: 1; padding: 40px 60px; background: white; min-width: 0; }
        .article-content h1 { font-size: 2.2rem; margin-bottom: 24px; font-weight: 300; }
        .article-content h2 { font-size: 1.6rem; margin: 1.5em 0 0.8em; border-bottom: 1px solid #eee; padding-bottom: 8px; font-weight: 400; }
        
        /* OI-Wiki æ‰©å±•æ ·å¼ï¼šæŠ˜å æ¡† */
        .admonition { margin: 1.5em 0; border: 1px solid #448aff; border-left-width: 0.3rem; border-radius: 4px; background: #fff; }
        .admonition-title { font-weight: bold; padding: 12px 16px; background: rgba(68, 138, 255, 0.1); display: flex; align-items: center; cursor: pointer; }
        .admonition-title::after { content: "\f078"; font-family: "Font Awesome 6 Free"; margin-left: auto; font-size: 0.8em; transition: 0.3s; }
        .admonition.collapsed .admonition-title::after { transform: rotate(-90deg); }
        .admonition-content { padding: 16px; }
        .admonition.collapsed .admonition-content { display: none; }
        .admonition.note { border-color: #448aff; }
        .admonition.question { border-color: #00bcd4; }
        .admonition.warning { border-color: #ff9100; }

        /* OI-Wiki æ‰©å±•æ ·å¼ï¼šé€‰é¡¹å¡ */
        .tab-container { margin: 1.5em 0; border: 1px solid #eee; border-radius: 6px; }
        .tab-nav { display: flex; background: #f8f9fb; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tab-btn { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 0.9em; color: #666; transition: 0.2s; }
        .tab-btn.active { color: var(--md-primary-fg-color); border-bottom: 2px solid var(--md-primary-fg-color); background: white; font-weight: bold; }
        .tab-pane { display: none; padding: 20px; }
        .tab-pane.active { display: block; }

        /* ä»£ç å— */
        pre { background: #f5f5f5; padding: 16px; border-radius: 4px; overflow-x: auto; margin: 1.5em 0; }
        code { font-family: 'JetBrains Mono', 'Consolas', monospace; font-size: 0.9em; }

        /* é€šç”¨ç»„ä»¶ */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: var(--md-primary-fg-color); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .input-field { padding: 12px; border: 1px solid #ddd; border-radius: 4px; width: 100%; margin-bottom: 15px; font-size: 1rem; }
        #editor-md { min-height: 500px; font-family: monospace; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { padding: 20px; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-title" onclick="Router.go('/')">
            <i class="fas fa-book-open"></i> HRT's Wiki
        </div>
        <div class="auth-zone" id="auth-ui"></div>
    </header>

    <div class="container">
        <aside class="sidebar" id="sidebar-nav"></aside>
        <main class="main-content" id="view-content">
            <div style="text-align:center; padding:100px; color:#999">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
            </div>
        </main>
    </div>

    <script>
        // --- åˆå§‹åŒ– Supabase (ä½¿ç”¨ db é¿å…å‘½åå†²çª) ---
        const CONFIG = {
            URL: 'https://qalinnggueysnsfrmoux.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhbGlubmdndWV5c25zZnJtb3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODUwNjgsImV4cCI6MjA4NjI2MTA2OH0.rlngJnOtXVs-Q1qXxN8iSrTCbjslJu0K_qouVsgOfj0'
        };
        const db = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
        
        let currentUser = null;
        let allArticles = [];

        // --- è·¯ç”±ç³»ç»Ÿ ---
        const Router = {
            getParams() {
                const path = window.location.pathname;
                const idMatch = path.match(/\/article\/([^/]+)/);
                return { 
                    id: idMatch ? idMatch[1] : null, 
                    isNew: path.endsWith('/new'), 
                    isEdit: path.endsWith('/edit') 
                };
            },
            go(path) {
                window.history.pushState(null, '', path);
                this.handle();
            },
            async handle() {
                const p = this.getParams();
                if (p.isNew) showEditor();
                else if (p.id && p.isEdit) showEditor(p.id);
                else if (p.id) showDetail(p.id);
                else showHome();
                renderSidebar();
            }
        };

        // --- æ ¸å¿ƒé€»è¾‘ ---
        async function init() {
            const { data: { session } } = await db.auth.getSession();
            currentUser = session?.user || null;
            updateAuthUI();
            await fetchArticles();
            Router.handle();
            window.onpopstate = () => Router.handle();
        }

        async function fetchArticles() {
            const { data, error } = await db.from('article').select('*').order('created_at', { ascending: false });
            if (!error) allArticles = data;
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const currentId = Router.getParams().id;
            const isHome = !currentId && !Router.getParams().isNew;

            let html = `<div class="nav-group-title">å¯¼èˆª</div>`;
            html += `<a class="nav-item ${isHome ? 'active' : ''}" onclick="Router.go('/')"><i class="fas fa-home"></i> é¦–é¡µ</a>`;
            if (currentUser) {
                html += `<a class="nav-item" style="color:#2e7d32" onclick="Router.go('/article/new')"><i class="fas fa-plus-circle"></i> æ–°å»ºæ–‡ç« </a>`;
            }

            html += `<div class="nav-group-title" style="margin-top:20px">æ‰€æœ‰å†…å®¹</div>`;
            // è¿‡æ»¤æ‰ä½œä¸ºé¦–é¡µçš„æ–‡ç«  id=home
            allArticles.filter(a => a.id !== 'home').forEach(a => {
                html += `<a class="nav-item ${currentId === a.id ? 'active' : ''}" onclick="Router.go('/article/${a.id}')">${escapeHtml(a.title)}</a>`;
            });
            nav.innerHTML = html;
        }

        async function showHome() {
            const homeArt = allArticles.find(a => a.id === 'home');
            if (homeArt) {
                renderArticleHTML(homeArt);
            } else {
                document.getElementById('view-content').innerHTML = `
                    <div class="article-content">
                        <h1>ğŸ‘‹ æ¬¢è¿æ¥åˆ° HRT's Wiki</h1>
                        <p>ç›®å‰è¿˜æ²¡æœ‰è®¾ç½®é¦–é¡µå†…å®¹ã€‚ç‚¹å‡»å·¦ä¾§æ–‡ç« å¼€å§‹é˜…è¯»ã€‚</p>
                        ${currentUser ? `<button class="btn btn-primary" onclick="createDefaultHome()">ä¸€é”®åˆå§‹åŒ–é¦–é¡µ</button>` : ''}
                    </div>`;
            }
        }

        async function showDetail(id) {
            const art = allArticles.find(a => a.id == id);
            if (!art) {
                document.getElementById('view-content').innerHTML = "<h1>404 æ–‡ç« æœªæ‰¾åˆ°</h1>";
                return;
            }
            renderArticleHTML(art);
        }

        function renderArticleHTML(article) {
            const container = document.getElementById('view-content');
            // é¢„å¤„ç†æ‰©å±•è¯­æ³•
            let processedMd = processMkDocsExtensions(article.md || '');
            
            container.innerHTML = `
                <div class="article-content">
                    <h1>${escapeHtml(article.title)}</h1>
                    <div style="font-size:13px; color:#999; margin-bottom:30px">
                        <i class="far fa-calendar-alt"></i> ${new Date(article.created_at).toLocaleDateString()}
                        ${currentUser ? ` | <a href="javascript:Router.go('/article/${article.id}/edit')">ç¼–è¾‘æ­¤é¡µ</a>` : ''}
                    </div>
                    <div id="md-render">${marked.parse(processedMd)}</div>
                </div>`;

            const target = document.getElementById('md-render');
            initAdmonitions(target);
            initTabs(target);
            
            // æ¸²æŸ“æ•°å­¦å…¬å¼å’Œé«˜äº®
            renderMathInElement(target, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
            target.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            window.scrollTo(0,0);
        }

        // --- OI-Wiki è¯­æ³•è§£ææ’ä»¶ ---
        function processMkDocsExtensions(md) {
            // è½¬æ¢ ???+ note "Title" ä¸ºç‰¹å®š HTML
            let res = md.replace(/\?\?\?\+?\s+(\w+)\s+"([^"]+)"/g, (m, type, title) => {
                return `<div class="admonition ${type}"><div class="admonition-title">${title}</div><div class="admonition-content">`;
            });
            // è½¬æ¢ === "Title" ä¸ºç‰¹å®š HTML
            res = res.replace(/===\s+"([^"]+)"/g, (m, title) => {
                return `<div class="raw-tab-pane" data-title="${title}">`;
            });
            // ç®€å•é—­åˆå¤„ç†ï¼šæœç´¢è¢«ç ´åçš„ç¼©è¿›ï¼ˆè¿™é‡Œç”¨äº†ä¸€ä¸ªå ä½ç¬¦ï¼Œç”± init å‡½æ•°åç½®å¤„ç†ï¼‰
            return res;
        }

        function initAdmonitions(container) {
            container.querySelectorAll('.admonition-title').forEach(t => {
                t.onclick = () => t.parentElement.classList.toggle('collapsed');
            });
        }

        function initTabs(container) {
            const rawPanes = Array.from(container.querySelectorAll('.raw-tab-pane'));
            let currentTabContainer = null;
            
            rawPanes.forEach(pane => {
                if (!currentTabContainer || pane.previousElementSibling?.className !== 'raw-tab-pane') {
                    currentTabContainer = document.createElement('div');
                    currentTabContainer.className = 'tab-container';
                    pane.parentNode.insertBefore(currentTabContainer, pane);
                    const nav = document.createElement('div');
                    nav.className = 'tab-nav';
                    currentTabContainer.appendChild(nav);
                }
                
                const title = pane.dataset.title;
                const btn = document.createElement('button');
                btn.className = 'tab-btn' + (currentTabContainer.querySelectorAll('.tab-btn').length === 0 ? ' active' : '');
                btn.innerText = title;
                
                const content = document.createElement('div');
                content.className = 'tab-pane' + (btn.classList.contains('active') ? ' active' : '');
                
                // å¯»æ‰¾ç›´åˆ°ä¸‹ä¸€ä¸ª raw-tab-pane ä¹‹å‰çš„æ‰€æœ‰å†…å®¹ä½œä¸ºå½“å‰ tab çš„å†…å®¹
                let next = pane.nextSibling;
                content.appendChild(pane); // å…ˆæŠŠæ ‡é¢˜å ä½ç¬¦ç§»è¿›å»
                while(next && next.className !== 'raw-tab-pane') {
                    let temp = next;
                    next = next.nextSibling;
                    content.appendChild(temp);
                }

                btn.onclick = () => {
                    btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    content.parentElement.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    content.classList.add('active');
                };

                currentTabContainer.querySelector('.tab-nav').appendChild(btn);
                currentTabContainer.appendChild(content);
            });
        }

        // --- ç¼–è¾‘å™¨åŠŸèƒ½ ---
        async function showEditor(id = null) {
            if(!currentUser) return Router.go('/');
            const art = id ? allArticles.find(a => a.id == id) : { title: '', md: '' };
            
            document.getElementById('view-content').innerHTML = `
                <div class="editor-wrap">
                    <h2 style="margin-bottom:20px">${id ? 'ç¼–è¾‘æ–‡ç« ' : 'åˆ›å»ºæ–°æ–‡ç« '}</h2>
                    <input id="ed-title" class="input-field" placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜..." value="${escapeHtml(art.title)}">
                    <textarea id="ed-md" class="input-field" placeholder="æ”¯æŒ Markdown å’Œ LaTeX...">$${art.md}</textarea>
                    <div style="display:flex; gap:12px">
                        <button class="btn btn-primary" onclick="saveArticle('${id || ''}')"><i class="fas fa-save"></i> ä¿å­˜å‘å¸ƒ</button>
                        ${id ? `<button class="btn" style="background:#ff5252; color:white" onclick="deleteArticle('${id}')">åˆ é™¤</button>` : ''}
                        <button class="btn" onclick="Router.go('/')">å–æ¶ˆ</button>
                    </div>
                </div>`;
        }

        async function saveArticle(id) {
            const title = document.getElementById('ed-title').value;
            const md = document.getElementById('ed-md').value;
            if(!title || !md) return alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");

            const payload = { title, md, updated_at: new Date() };
            let res;

            if(id) {
                res = await db.from('article').update(payload).eq('id', id);
            } else {
                // ç”Ÿæˆä¸€ä¸ªéšæœº ID (10ä½ï¼Œé¿å… 8ä½é™åˆ¶æŠ¥é”™)
                id = Math.random().toString(36).substr(2, 10);
                payload.id = id;
                res = await db.from('article').insert([payload]);
            }

            if(res.error) alert("é”™è¯¯: " + res.error.message);
            else {
                await fetchArticles();
                Router.go(id === 'home' ? '/' : '/article/' + id);
            }
        }

        async function deleteArticle(id) {
            if(!confirm("ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ")) return;
            const { error } = await db.from('article').delete().eq('id', id);
            if(!error) { await fetchArticles(); Router.go('/'); }
        }

        async function createDefaultHome() {
            const payload = { id: 'home', title: 'é¦–é¡µ', md: '# æ¬¢è¿æ¥åˆ°æˆ‘çš„çŸ¥è¯†åº“\nè¯·ç‚¹å‡»å·¦ä¾§æ–‡ç« å¼€å§‹æ¢ç´¢ã€‚', created_at: new Date() };
            await db.from('article').insert([payload]);
            await fetchArticles();
            Router.handle();
        }

        // --- ç™»å½• UI ---
        function updateAuthUI() {
            const zone = document.getElementById('auth-ui');
            if (currentUser) {
                zone.innerHTML = `<span style="font-size:13px; margin-right:15px; opacity:0.8">${currentUser.email}</span>
                                  <button class="btn" style="background:rgba(255,255,255,0.2); color:white" onclick="doLogout()">é€€å‡º</button>`;
            } else {
                zone.innerHTML = `<button class="btn" style="background:rgba(255,255,255,0.2); color:white" onclick="doLogin()">ç™»å½•</button>`;
            }
        }

        async function doLogin() {
            const email = prompt("ç®¡ç†å‘˜é‚®ç®±:");
            const password = prompt("å¯†ç :");
            if (email && password) {
                const { error } = await db.auth.signInWithPassword({ email, password });
                if (error) alert("ç™»å½•å¤±è´¥: " + error.message);
                else location.reload();
            }
        }

        async function doLogout() {
            await db.auth.signOut();
            location.reload();
        }

        function escapeHtml(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }

        window.onload = init;
    </script>
</body>
</html>
