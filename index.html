<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRT's Wiki</title>
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1057417.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root { --md-primary-fg-color: #3f51b5; --sidebar-width: 260px; --header-height: 48px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', 'Noto Sans SC', sans-serif; background: #fff; display: flex; flex-direction: column; }

        /* 布局 */
        .header { background: var(--md-primary-fg-color); color: white; height: var(--header-height); display: flex; align-items: center; padding: 0 20px; position: fixed; width: 100%; z-index: 1000; }
        .container { display: flex; margin-top: var(--header-height); max-width: 1200px; margin: var(--header-height) auto 0; width: 100%; }
        .sidebar { width: var(--sidebar-width); background: #f8f9fb; border-right: 1px solid #eee; position: sticky; top: var(--header-height); height: calc(100vh - var(--header-height)); overflow-y: auto; padding: 20px 0; }
        .main-content { flex: 1; padding: 40px; min-width: 0; background: white; }

        /* MkDocs Admonition (折叠/提示框) */
        .admonition { margin: 1.5em 0; border-left: 0.2rem solid #448aff; background: #f8f9fb; border-radius: 0.1rem; overflow: hidden; }
        .admonition-title { font-weight: bold; background: rgba(68,138,255,0.1); padding: 0.5rem 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .admonition-title::before { content: '\f05a'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
        .admonition.question { border-left-color: #29b6f6; }
        .admonition.question .admonition-title { background: rgba(41,182,246,0.1); }
        .admonition.warning { border-left-color: #ffa726; }
        .admonition-content { padding: 0.8rem; }
        .admonition.collapsed .admonition-content { display: none; }

        /* MkDocs Tabs (选项卡) */
        .tab-group { margin: 1.5em 0; border: 1px solid #eee; border-radius: 4px; }
        .tab-nav { display: flex; background: #f8f9fb; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 0.85rem; white-space: nowrap; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--md-primary-fg-color); color: var(--md-primary-fg-color); font-weight: bold; }
        .tab-pane { display: none; padding: 15px; }
        .tab-pane.active { display: block; }

        /* 内容样式 */
        .article-content { line-height: 1.7; color: #333; }
        .article-content h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        .article-content pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; margin: 1rem 0; overflow-x: auto; }
        code { font-family: 'JetBrains Mono', monospace; }
        
        .nav-item { display: block; padding: 8px 20px; color: #444; text-decoration: none; cursor: pointer; font-size: 0.9rem; }
        .nav-item.active { color: var(--md-primary-fg-color); background: #e8eaf6; border-left: 3px solid var(--md-primary-fg-color); }
        .btn { padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; }
        .btn-primary { background: var(--md-primary-fg-color); color: white; border: none; }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: bold; cursor:pointer" onclick="Router.go('/')">HRT's Wiki</div>
    <div id="auth-ui" style="margin-left: auto;"></div>
</header>

<div class="container">
    <aside class="sidebar" id="sidebar-nav"></aside>
    <main class="main-content" id="view-content"></main>
</div>

<script>
    const CONFIG = {
        URL: 'https://qalinnggueysnsfrmoux.supabase.co',
        KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhbGlubmdndWV5c25zZnJtb3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODUwNjgsImV4cCI6MjA4NjI2MTA2OH0.rlngJnOtXVs-Q1qXxN8iSrTCbjslJu0K_qouVsgOfj0'
    };
    const db = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
    let allArticles = [];
    let currentUser = null;

    // --- 扩展语法解析器 ---
    function parseMkDocs(md) {
        // 1. 处理折叠面板 ???+ type "Title"
        md = md.replace(/\?\?\?\+?\s+(\w+)\s+"([^"]+)"/g, (match, type, title) => {
            const isCollapsed = !match.includes('???+');
            return `<div class="admonition ${type} ${isCollapsed ? 'collapsed' : ''}"><div class="admonition-title">${title}</div><div class="admonition-content">`;
        });
        // 闭合提示框（这里通过简单的缩进结束判断比较难，简单起见我们要求内容后接空行或结束）
        // 改进：OI-Wiki 常用缩进代表内容。这里简化处理：遇到下一个组件前闭合。
        
        // 2. 处理选项卡 === "Title"
        // 逻辑：将连续的 === 包装成一个 tab-group
        let lines = md.split('\n');
        let newLines = [];
        let inTabGroup = false;

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            let tabMatch = line.match(/^===\s+"([^"]+)"/);
            if (tabMatch) {
                if (!inTabGroup) {
                    newLines.push('<div class="tab-group"><div class="tab-nav"></div><div class="tab-body">');
                    inTabGroup = true;
                }
                newLines.push(`</div><div class="tab-pane" data-title="${tabMatch[1]}">`);
            } else if (inTabGroup && (line.trim() === "" && (i+1 < lines.length && !lines[i+1].startsWith('    ') && !lines[i+1].startsWith('===')))) {
                // 如果遇到没有缩进的行，且不是新 tab，则关闭 group
                newLines.push('</div></div>');
                inTabGroup = false;
                newLines.push(line);
            } else {
                newLines.push(line);
            }
        }
        if (inTabGroup) newLines.push('</div></div>');
        return newLines.join('\n');
    }

    // --- 路由与UI逻辑 ---
    const Router = {
        go(path) { window.history.pushState(null, '', path); this.handle(); },
        async handle() {
            const path = window.location.pathname;
            const id = path.match(/\/article\/([^/]+)/)?.[1];
            if (path.endsWith('/edit')) showEditor(id);
            else if (path.endsWith('/new')) showEditor();
            else if (id) showDetail(id);
            else showHome();
            renderSidebar();
        }
    };

    async function init() {
        const { data: { session } } = await db.auth.getSession();
        currentUser = session?.user;
        updateAuthUI();
        await fetchArticles();
        Router.handle();
    }

    async function fetchArticles() {
        const { data } = await db.from('article').select('*').order('created_at', { ascending: false });
        allArticles = data || [];
    }

    function renderSidebar() {
        const nav = document.getElementById('sidebar-nav');
        const curId = window.location.pathname.split('/')[2];
        nav.innerHTML = `<div style="padding:10px 20px; font-size:12px; color:#999">文章列表</div>` + 
            allArticles.map(a => `<a class="nav-item ${curId==a.id?'active':''}" onclick="Router.go('/article/${a.id}')">${a.title}</a>`).join('');
    }

    function showDetail(id) {
        const art = allArticles.find(a => a.id == id);
        const container = document.getElementById('view-content');
        if (!art) return container.innerHTML = "未找到";

        container.innerHTML = `
            <div class="article-content">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h1>${art.title}</h1>
                    ${currentUser ? `<button class="btn" onclick="Router.go('/article/${id}/edit')">编辑</button>` : ''}
                </div>
                <hr style="margin:20px 0; border:none; border-top:1px solid #eee">
                <div id="render-area"></div>
            </div>
        `;

        const area = document.getElementById('render-area');
        // 先用扩展解析，再用 marked 解析
        area.innerHTML = marked.parse(parseMkDocs(art.md || ''));

        // 处理折叠逻辑
        document.querySelectorAll('.admonition-title').forEach(el => {
            el.onclick = () => el.parentElement.classList.toggle('collapsed');
        });

        // 处理选项卡 UI 生成
        document.querySelectorAll('.tab-group').forEach(group => {
            const nav = group.querySelector('.tab-nav');
            const panes = group.querySelectorAll('.tab-pane');
            panes.forEach((pane, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn' + (idx === 0 ? ' active' : '');
                btn.innerText = pane.dataset.title;
                btn.onclick = () => {
                    group.querySelectorAll('.tab-btn, .tab-pane').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                    pane.classList.add('active');
                };
                nav.appendChild(btn);
                if(idx === 0) pane.classList.add('active');
            });
        });

        // 公式和代码
        renderMathInElement(area, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
        area.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    }

    // --- 其他基础功能 (登录、编辑等省略，保持与之前一致) ---
    // ... (此处保留之前的 saveArticle, showEditor, showHome 函数)
    
    function updateAuthUI() {
        document.getElementById('auth-ui').innerHTML = currentUser ? 
            `<button class="btn" onclick="db.auth.signOut().then(()=>location.reload())">退出</button>` : 
            `<button class="btn" onclick="promptLogin()">登录</button>`;
    }
    
    async function promptLogin() {
        const email = prompt("Email:"), pw = prompt("Password:");
        const { error } = await db.auth.signInWithPassword({ email, password: pw });
        if(!error) location.reload();
    }

    window.onload = init;
    window.onpopstate = () => Router.handle();
</script>
</body>
</html>
