<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiki</title>
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1057417.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css" id="hljs-theme">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        :root {
            --bg-body: #ffffff;
            --bg-sidebar: #f5f5f7;
            --bg-card: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent: #0066cc;
            --border: #d2d2d7;
            --divider: #e5e5ea;
            --glass: rgba(255, 255, 255, 0.85);
            --nav-hover: rgba(0,0,0,0.05);
            --code-bg: #f5f5f7;
            --header-h: 52px;
            --sidebar-w: 260px;
            --toc-w: 240px;
        }

        [data-theme="dark"] {
            --bg-body: #000000;
            --bg-sidebar: #1c1c1e;
            --bg-card: #1c1c1e;
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --accent: #2997ff;
            --border: #424245;
            --divider: #38383a;
            --glass: rgba(28, 28, 30, 0.85);
            --nav-hover: rgba(255,255,255,0.1);
            --code-bg: #2c2c2e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
            overflow-y: scroll;
        }

        /* 顶部导航 */
        .header {
            position: fixed; top: 0; width: 100%; height: var(--header-h);
            background: var(--glass);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--divider);
            z-index: 1000;
            display: flex; align-items: center; padding: 0 24px;
        }
        .header-inner { max-width: 1400px; margin: 0 auto; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 600; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .header-controls { display: flex; gap: 16px; align-items: center; }
        .icon-btn { cursor: pointer; font-size: 1.1rem; color: var(--text-primary); background: none; border: none; opacity: 0.8; transition: 0.2s; }
        .icon-btn:hover { opacity: 1; color: var(--accent); }

        /* 布局 */
        .layout {
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr var(--toc-w);
            max-width: 1400px;
            margin: var(--header-h) auto 0;
            min-height: calc(100vh - var(--header-h));
        }

        /* 侧边栏 */
        .sidebar {
            position: sticky; top: var(--header-h); height: calc(100vh - var(--header-h));
            overflow-y: auto; padding: 30px 20px;
            border-right: 1px solid var(--divider);
            background: var(--bg-body);
        }
        .nav-group { margin-bottom: 24px; }
        .nav-title { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; padding-left: 10px; }
        .nav-item {
            display: block; padding: 8px 12px; border-radius: 8px;
            color: var(--text-primary); text-decoration: none; font-size: 0.9rem; font-weight: 500;
            transition: 0.2s; cursor: pointer; margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--nav-hover); }
        .nav-item.active { background: var(--nav-hover); color: var(--accent); }

        /* 内容区 */
        .main-content { padding: 40px 60px; min-width: 0; }

        /* 右侧大纲 */
        .toc-sidebar {
            position: sticky; top: var(--header-h); height: calc(100vh - var(--header-h));
            overflow-y: auto; padding: 40px 20px;
        }
        .toc-header { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 15px; }
        .toc-link {
            display: block; text-decoration: none; color: var(--text-secondary);
            font-size: 0.85rem; padding: 4px 0 4px 12px; border-left: 2px solid var(--divider);
            transition: 0.2s;
        }
        .toc-link:hover { color: var(--text-primary); }
        .toc-link.active { color: var(--accent); border-left-color: var(--accent); }
        .toc-link.h3 { padding-left: 24px; }

        /* 排版样式 */
        h1 { font-size: 2.5rem; margin-bottom: 0.5em; font-weight: 700; letter-spacing: -0.02em; }
        h2 { font-size: 1.8rem; margin: 1.5em 0 0.8em; padding-bottom: 0.3em; border-bottom: 1px solid var(--divider); scroll-margin-top: 80px; }
        h3 { font-size: 1.4rem; margin: 1.2em 0 0.5em; scroll-margin-top: 80px; }
        p { margin-bottom: 1.2em; }
        code { font-family: "SF Mono", monospace; font-size: 0.9em; background: var(--nav-hover); padding: 2px 6px; border-radius: 6px; color: var(--accent); }
        pre { background: var(--code-bg); padding: 20px; border-radius: 12px; overflow-x: auto; margin: 1.5em 0; border: 1px solid var(--divider); }
        img { max-width: 100%; border-radius: 12px; margin: 1em 0; }

        /* 折叠框与选项卡 */
        .admonition { margin: 1.5em 0; border-radius: 12px; border: 1px solid var(--divider); background: var(--bg-card); overflow: hidden; }
        .admonition-title { padding: 12px 16px; background: var(--nav-hover); font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; cursor: pointer; }
        .admonition-title i { margin-right: 10px; }
        .admonition-title::after { content: "\f078"; font-family: "Font Awesome 6 Free"; margin-left: auto; font-size: 0.8em; transition: 0.3s; }
        .admonition.collapsed .admonition-title::after { transform: rotate(-90deg); }
        .admonition-content { padding: 20px; border-top: 1px solid var(--divider); }
        .admonition.collapsed .admonition-content { display: none; }
        
        .admonition.note .admonition-title { color: #0066cc; }
        .admonition.warning .admonition-title { color: #ff9500; }
        .admonition.danger .admonition-title { color: #ff3b30; }

        .tab-group { margin: 1.5em 0; border: 1px solid var(--divider); border-radius: 12px; background: var(--bg-card); }
        .tab-labels { display: flex; background: var(--nav-hover); border-bottom: 1px solid var(--divider); overflow-x: auto; }
        .tab-label { padding: 10px 20px; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab-label.active { color: var(--text-primary); border-bottom-color: var(--accent); }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 加载状态 */
        #loading-screen { position: fixed; top: 52px; left: 0; right: 0; bottom: 0; background: var(--bg-body); z-index: 500; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        
        /* 响应式 */
        @media (max-width: 1100px) { .toc-sidebar { display: none; } .layout { grid-template-columns: var(--sidebar-w) 1fr; } }
        @media (max-width: 768px) { .sidebar { display: none; } .layout { grid-template-columns: 1fr; } .main-content { padding: 30px 20px; } }
        
        /* 编辑器 */
        .editor-input { width: 100%; padding: 10px; font-size: 1.5rem; border: none; background: transparent; color: var(--text-primary); font-weight: bold; margin-bottom: 20px; font-family: inherit; }
        .editor-area { width: 100%; min-height: 60vh; padding: 15px; background: var(--bg-sidebar); border-radius: 8px; border: none; color: var(--text-primary); resize: vertical; font-family: "SF Mono", monospace; }
        .btn { padding: 8px 16px; border-radius: 18px; border: none; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-ghost { background: transparent; color: var(--text-secondary); }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-inner">
            <div class="logo" onclick="Router.go('/')">HRT's Wiki</div>
            <div class="header-controls">
                <button class="icon-btn" onclick="toggleTheme()"><i class="fas fa-moon" id="theme-icon"></i></button>
                <div id="auth-box"></div>
            </div>
        </div>
    </header>

    <div id="loading-screen"><i class="fas fa-spinner fa-spin fa-2x"></i></div>

    <div class="layout">
        <aside class="sidebar" id="sidebar-nav"></aside>
        <main class="main-content" id="view-area"></main>
        <aside class="toc-sidebar">
            <div class="toc-header">ON THIS PAGE</div>
            <div id="toc-list"></div>
        </aside>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- 系统初始化 ---
        function initTheme() {
            const t = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('theme-icon').className = t==='dark' ? 'fas fa-sun' : 'fas fa-moon';
            document.getElementById('hljs-theme').href = t==='dark' 
                ? "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css"
                : "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css";
        }
        function toggleTheme() {
            const cur = document.documentElement.getAttribute('data-theme');
            const nxt = cur === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', nxt);
            initTheme();
        }
        initTheme();

        // --- Supabase ---
        const CONFIG = {
            URL: 'https://qalinnggueysnsfrmoux.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhbGlubmdndWV5c25zZnJtb3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODUwNjgsImV4cCI6MjA4NjI2MTA2OH0.rlngJnOtXVs-Q1qXxN8iSrTCbjslJu0K_qouVsgOfj0'
        };
        const db = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
        let currentUser = null, allArticles = [];

        // --- 核心解析器 (保持折叠框/Tabs功能) ---
        function parseAndRender(md) {
            if (!md) return '';
            const lines = md.split('\n');
            let html = '', buf = [];

            const flush = () => { if(buf.length){ html+=marked.parse(buf.join('\n')); buf=[]; }};

            for(let i=0; i<lines.length; i++){
                let line = lines[i];
                const adm = line.match(/^(\?{3}\+?)\s+(\w+)(?:\s+"([^"]+)")?/);
                const tab = line.match(/^===\s+"([^"]+)"/);

                if(adm){
                    flush();
                    let content=[], base=-1; i++;
                    while(i<lines.length){
                        const nl=lines[i], ni=nl.search(/\S|$/);
                        if(!nl.trim()){ content.push(''); i++; continue; }
                        if(base===-1) base=ni;
                        if(ni<base){ i--; break; }
                        content.push(nl.substring(base)); i++;
                    }
                    const inner = parseAndRender(content.join('\n'));
                    const [_,s,type,ti] = adm;
                    const icon = type==='warning'?'fa-exclamation-triangle':(type==='danger'?'fa-bolt':'fa-info-circle');
                    html += `<div class="admonition ${type} ${s.includes('+')?'':'collapsed'}"><div class="admonition-title" onclick="this.parentElement.classList.toggle('collapsed')"><i class="fas ${icon}"></i>${ti||type.toUpperCase()}</div><div class="admonition-content">${inner}</div></div>`;
                }
                else if(tab){
                    flush();
                    let tabs=[]; i--;
                    while(i+1<lines.length){
                        const nm = lines[i+1].match(/^===\s+"([^"]+)"/);
                        if(!nm) break;
                        i++;
                        let tc=[], tb=-1; i++;
                        while(i<lines.length){
                            const nl=lines[i], ni=nl.search(/\S|$/);
                            if(!nl.trim()){ tc.push(''); i++; continue; }
                            if(tb===-1) tb=ni;
                            if(ni<tb){ i--; break; }
                            tc.push(nl.substring(tb)); i++;
                        }
                        tabs.push({t:nm[1], c:tc.join('\n')});
                    }
                    if(tabs.length){
                        const uid = Math.random().toString(36).substr(2,6);
                        let ls='', cs='';
                        tabs.forEach((t,ix)=>{
                            const a = ix===0?'active':'';
                            ls+=`<div class="tab-label ${a}" onclick="swTab('${uid}',${ix})">${t.t}</div>`;
                            cs+=`<div class="tab-content ${a}">${parseAndRender(t.c)}</div>`;
                        });
                        html+=`<div class="tab-group" id="tb-${uid}"><div class="tab-labels">${ls}</div>${cs}</div>`;
                    }
                } else { buf.push(line); }
            }
            flush();
            return html;
        }
        window.swTab = (u,x) => {
            const g=document.getElementById(`tb-${u}`);
            g.querySelectorAll('.tab-label').forEach((e,i)=>e.classList.toggle('active',i===x));
            g.querySelectorAll('.tab-content').forEach((e,i)=>e.classList.toggle('active',i===x));
        };

        // --- 逻辑控制 ---
        const Router = {
            get() { const p=window.location.pathname; return { id:p.match(/\/article\/([^/]+)/)?.[1], new:p.endsWith('/new'), edit:p.endsWith('/edit') }; },
            go(p) { window.history.pushState(null,'',p); this.handle(); },
            handle() {
                const p = this.get();
                // 隐藏/显示 TOC
                document.querySelector('.toc-sidebar').style.display = (p.new||p.edit) ? 'none' : 'block';
                
                if(p.new) renderEditor();
                else if(p.id && p.edit) renderEditor(p.id);
                else if(p.id) showDetail(p.id);
                else renderHome();
                
                renderSidebar();
            }
        };

        async function fetchArticles() {
            try {
                const {data, error} = await db.from('article').select('*').order('created_at',{ascending:false});
                if(error) throw error;
                allArticles = data || [];
                // 移除加载遮罩
                document.getElementById('loading-screen').style.display = 'none';
            } catch(e) {
                console.error(e);
                document.getElementById('loading-screen').innerHTML = `<div style="text-align:center"><p>连接失败</p><small>${e.message}</small></div>`;
            }
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const cur = Router.get().id;
            let h = `<div class="nav-group"><div class="nav-title">Menu</div>`;
            h += `<a class="nav-item ${!cur?'active':''}" onclick="Router.go('/')">首页</a>`;
            if(currentUser) h += `<a class="nav-item" onclick="Router.go('/article/new')">+ 新建</a>`;
            h += `</div><div class="nav-group"><div class="nav-title">Articles</div>`;
            allArticles.filter(a=>a.id!=='home').forEach(a=>{
                h += `<a class="nav-item ${cur==a.id?'active':''}" onclick="Router.go('/article/${a.id}')">${escapeHtml(a.title)}</a>`;
            });
            h += `</div>`;
            nav.innerHTML = h;
        }

        async function renderHome() {
            const home = allArticles.find(a=>a.id==='home');
            if(home) showDetail('home');
            else document.getElementById('view-area').innerHTML = `<div style="text-align:center;margin-top:100px;"><h1>Welcome</h1><p>Wiki Ready.</p>${currentUser?`<button class="btn btn-primary" onclick="initHome()">Init Home</button>`:''}</div>`;
        }

        async function showDetail(id) {
            const art = allArticles.find(a=>a.id==id);
            if(!art) return;
            const html = parseAndRender(art.md||'');
            const c = document.getElementById('view-area');
            c.innerHTML = `<h1>${escapeHtml(art.title)}</h1><div style="margin-bottom:30px;color:var(--text-secondary);font-size:0.9rem">${new Date(art.created_at).toLocaleDateString()} ${currentUser?` · <a onclick="Router.go('/article/${id}/edit')" style="cursor:pointer;color:var(--accent)">编辑</a>`:''}</div><div id="md-root">${html}</div>`;
            
            // 后处理
            const root = document.getElementById('md-root');
            renderMathInElement(root, {delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false}]});
            root.querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
            genTOC();
            window.scrollTo(0,0);
        }

        function genTOC() {
            const root = document.getElementById('md-root');
            const heads = root.querySelectorAll('h2, h3');
            const toc = document.getElementById('toc-list');
            toc.innerHTML = '';
            
            if(heads.length===0) return toc.innerHTML = '<div style="color:var(--text-secondary);font-size:0.85rem">暂无目录</div>';

            const observer = new IntersectionObserver(e => {
                e.forEach(entry => {
                    if(entry.isIntersecting){
                        document.querySelectorAll('.toc-link').forEach(l=>l.classList.remove('active'));
                        const l = document.getElementById('link-'+entry.target.id);
                        if(l) l.classList.add('active');
                    }
                });
            }, {rootMargin:'-100px 0px -60% 0px'});

            heads.forEach((h,i) => {
                h.id = 'h-'+i;
                const link = document.createElement('a');
                link.className = `toc-link ${h.tagName.toLowerCase()}`;
                link.innerText = h.innerText;
                link.id = 'link-h-'+i;
                link.onclick = () => { document.getElementById('h-'+i).scrollIntoView({behavior:'smooth'}); };
                toc.appendChild(link);
                observer.observe(h);
            });
        }

        async function renderEditor(id=null) {
            if(!currentUser) return Router.go('/');
            const art = id?allArticles.find(a=>a.id==id):{title:'',md:''};
            document.getElementById('view-area').innerHTML = `
                <div class="editor-wrap">
                    <input id="ed-title" class="input-title" value="${escapeHtml(art.title)}" placeholder="Title">
                    <textarea id="ed-md" class="editor-area" placeholder="Markdown...">${art.md}</textarea>
                    <div style="margin-top:20px"><button class="btn btn-primary" onclick="save('${id||''}')">Save</button> <button class="btn btn-ghost" onclick="Router.go('/')">Cancel</button></div>
                </div>`;
            document.getElementById('toc-list').innerHTML = '';
        }

        async function save(id) {
            const t = document.getElementById('ed-title').value;
            const m = document.getElementById('ed-md').value;
            const fid = id || Math.random().toString(36).substr(2,10);
            const p = {id:fid, title:t, md:m, updated_at:new Date()};
            const {error} = id ? await db.from('article').update(p).eq('id',id) : await db.from('article').insert([p]);
            if(error) alert(error.message); else { await fetchArticles(); Router.go(fid==='home'?'/':`/article/${fid}`); }
        }

        async function initHome(){ await db.from('article').insert([{id:'home',title:'Home',md:'Welcome!',created_at:new Date()}]); await fetchArticles(); Router.handle(); }
        async function checkAuth(){ const {data}=await db.auth.getSession(); currentUser=data.session?.user; document.getElementById('auth-box').innerHTML=currentUser?`<button class="btn btn-ghost" onclick="db.auth.signOut().then(()=>location.reload())">退出</button>`:`<button class="btn btn-primary" onclick="login()">登录</button>`; }
        async function login(){ const e=prompt("Email"),p=prompt("Password"); if(e&&p) await db.auth.signInWithPassword({email:e,password:p}).then(()=>location.reload()); }
        function escapeHtml(s){const d=document.createElement('div');d.innerText=s;return d.innerHTML;}

        // 启动
        (async()=>{ await checkAuth(); await fetchArticles(); Router.handle(); window.onpopstate=()=>Router.handle(); })();
    </script>
</body>
</html>
