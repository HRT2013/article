<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRT's Wiki</title>
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1057417.png" type="image/png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        :root {
            --primary: #3f51b5;
            --text: #333;
            --bg: #fff;
            --code-bg: #f8f8f8;
            --sidebar-w: 280px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background: #fafafa; color: var(--text); line-height: 1.6; display: flex; flex-direction: column; height: 100vh; }

        /* 顶部导航 */
        .header { height: 56px; background: var(--primary); color: #fff; display: flex; align-items: center; padding: 0 24px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; position: fixed; width: 100%; top: 0; }
        .header-title { font-size: 1.2rem; font-weight: 500; cursor: pointer; display: flex; gap: 10px; align-items: center; }

        /* 主容器 */
        .container { display: flex; margin-top: 56px; height: calc(100vh - 56px); max-width: 1400px; margin: 56px auto 0; width: 100%; }

        /* 侧边栏 */
        .sidebar { width: var(--sidebar-w); background: #fff; border-right: 1px solid #eee; overflow-y: auto; padding: 20px 0; flex-shrink: 0; }
        .nav-item { padding: 10px 24px; cursor: pointer; color: #555; font-size: 0.9rem; border-left: 4px solid transparent; }
        .nav-item:hover { background: #f0f0f0; color: var(--primary); }
        .nav-item.active { background: #e8eaf6; color: var(--primary); border-left-color: var(--primary); font-weight: 500; }
        .nav-header { padding: 10px 24px; font-size: 0.8rem; font-weight: bold; color: #999; text-transform: uppercase; margin-top: 10px; }

        /* 内容区 */
        .main { flex: 1; padding: 40px 60px; overflow-y: auto; background: #fff; scroll-behavior: smooth; }
        .article-body { max-width: 900px; margin: 0 auto; }
        
        /* 排版样式 */
        h1 { font-size: 2.2rem; margin-bottom: 20px; font-weight: 300; line-height: 1.2; }
        h2 { font-size: 1.6rem; margin: 40px 0 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-weight: 400; }
        h3 { font-size: 1.3rem; margin: 30px 0 15px; font-weight: 500; }
        p { margin-bottom: 16px; }
        ul, ol { padding-left: 2em; margin-bottom: 16px; }
        code { font-family: 'JetBrains Mono', monospace; background: rgba(0,0,0,0.05); padding: 2px 5px; border-radius: 3px; font-size: 0.9em; }
        pre { background: var(--code-bg); padding: 15px; border-radius: 4px; overflow-x: auto; margin: 1.5em 0; }
        pre code { background: transparent; padding: 0; }

        /* --- OI-Wiki 组件样式 --- */
        
        /* 1. 折叠框 (Admonition) */
        .admonition { margin: 1.5em 0; border-left: 4px solid #448aff; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 4px; overflow: hidden; }
        .admonition-title { 
            background: rgba(68, 138, 255, 0.1); 
            padding: 10px 16px; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            cursor: pointer; 
            user-select: none;
        }
        .admonition-title i { margin-right: 10px; color: #448aff; }
        .admonition-title::after { content: "\f078"; font-family: "Font Awesome 6 Free"; margin-left: auto; transition: 0.3s; font-size: 0.8em; }
        .admonition.collapsed .admonition-title::after { transform: rotate(-90deg); }
        .admonition-content { padding: 16px 20px; border-top: 1px solid rgba(0,0,0,0.05); }
        .admonition.collapsed .admonition-content { display: none; }
        
        /* 不同类型配色 */
        .admonition.note { border-color: #448aff; } .admonition.note .admonition-title { background: rgba(68,138,255,0.1); }
        .admonition.warning { border-color: #ff9800; } .admonition.warning .admonition-title { background: rgba(255,152,0,0.1); } .admonition.warning i { color: #ff9800; }
        .admonition.failure, .admonition.danger { border-color: #f44336; } .admonition.failure .admonition-title { background: rgba(244,67,54,0.1); } .admonition.failure i { color: #f44336; }
        
        /* 2. 选项卡 (Tabs) */
        .tab-group { margin: 1.5em 0; border: 1px solid #eee; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .tab-labels { display: flex; background: #f5f5f5; border-bottom: 1px solid #ddd; overflow-x: auto; }
        .tab-label { padding: 10px 20px; cursor: pointer; font-size: 0.9rem; color: #666; border-bottom: 2px solid transparent; transition: 0.2s; white-space: nowrap; }
        .tab-label:hover { background: rgba(0,0,0,0.03); }
        .tab-label.active { color: var(--primary); border-bottom-color: var(--primary); background: #fff; font-weight: 500; }
        .tab-content { display: none; padding: 20px; background: #fff; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 编辑器 */
        .editor-wrap { display: flex; flex-direction: column; height: 100%; }
        .editor-input { padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-size: 1rem; }
        .editor-area { flex: 1; padding: 15px; border: 1px solid #ddd; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.5; resize: none; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 10px; }
        .btn-primary { background: var(--primary); color: #fff; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { padding: 20px; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-title" onclick="Router.go('/')"><i class="fas fa-book-open"></i> HRT's Wiki</div>
        <div id="auth-box" style="margin-left:auto"></div>
    </header>

    <div class="container">
        <aside class="sidebar" id="sidebar-nav"></aside>
        <main class="main" id="view-area"></main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- 1. Supabase 配置 ---
        const CONFIG = {
            URL: 'https://qalinnggueysnsfrmoux.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhbGlubmdndWV5c25zZnJtb3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODUwNjgsImV4cCI6MjA4NjI2MTA2OH0.rlngJnOtXVs-Q1qXxN8iSrTCbjslJu0K_qouVsgOfj0'
        };
        const db = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
        let currentUser = null;
        let allArticles = [];

        // --- 2. 核心解析器：分治法 (Divide & Render) ---
        // 解决 "Marked 不渲染 HTML 内部 Markdown" 的问题的关键
        
        function parseAndRender(markdown) {
            if (!markdown) return '';
            const lines = markdown.split('\n');
            let resultHTML = '';
            let buffer = []; // 存储普通 Markdown 行

            // 辅助：渲染并清空缓冲区
            const flushBuffer = () => {
                if (buffer.length > 0) {
                    resultHTML += marked.parse(buffer.join('\n'));
                    buffer = [];
                }
            };

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                const indent = line.search(/\S|$/); // 获取缩进级别 (空格数)
                const trimmed = line.trim();

                // 识别折叠框: ???+ note "Title"
                const admMatch = line.match(/^(\?{3}\+?)\s+(\w+)(?:\s+"([^"]+)")?/);
                
                // 识别选项卡: === "Title"
                const tabMatch = line.match(/^===\s+"([^"]+)"/);

                if (admMatch) {
                    flushBuffer();
                    // 提取整个块
                    let blockLines = [];
                    let baseIndent = -1; 
                    
                    // 向下扫描直到缩进结束
                    i++;
                    while (i < lines.length) {
                        const nextLine = lines[i];
                        const nextIndent = nextLine.search(/\S|$/);
                        if (nextLine.trim() === '') {
                            blockLines.push(''); // 保留空行
                            i++;
                            continue;
                        }
                        if (baseIndent === -1) baseIndent = nextIndent; // 确定内容的基础缩进
                        
                        // 如果遇到缩进比内容基础缩进还小的非空行，说明块结束了
                        if (nextIndent < baseIndent) {
                            i--; // 回退一行，交给外层循环处理
                            break;
                        }
                        // 去除基础缩进
                        blockLines.push(nextLine.substring(baseIndent));
                        i++;
                    }
                    
                    // 递归渲染块内部内容！这是关键！
                    const innerHTML = parseAndRender(blockLines.join('\n'));
                    
                    // 组装 HTML
                    const [_, sym, type, title] = admMatch;
                    const isCollapsed = !sym.includes('+');
                    const displayTitle = title || type.toUpperCase();
                    let icon = 'fa-info-circle';
                    if (type === 'warning') icon = 'fa-exclamation-triangle';
                    if (type === 'failure') icon = 'fa-times-circle';

                    resultHTML += `
                        <div class="admonition ${type} ${isCollapsed ? 'collapsed' : ''}">
                            <div class="admonition-title" onclick="this.parentElement.classList.toggle('collapsed')">
                                <i class="fas ${icon}"></i> ${displayTitle}
                            </div>
                            <div class="admonition-content">${innerHTML}</div>
                        </div>`;
                    
                } else if (tabMatch) {
                    flushBuffer();
                    // 选项卡通常是成组出现的，我们需要收集连续的 Tab 块
                    let tabs = [];
                    
                    // 回退一行以便进入循环统一处理
                    i--; 
                    while (i + 1 < lines.length) {
                        const nextHeaderLine = lines[i + 1];
                        const nextTabMatch = nextHeaderLine.match(/^===\s+"([^"]+)"/);
                        if (!nextTabMatch) break; // 下一行不是 Tab 头，结束组
                        
                        i++; // 消费 Header 行
                        const tabTitle = nextTabMatch[1];
                        let tabContentLines = [];
                        let tabBaseIndent = -1;

                        // 消费 Content
                        i++;
                        while (i < lines.length) {
                            const nextContentLine = lines[i];
                            const nextIndent = nextContentLine.search(/\S|$/);
                            if (nextContentLine.trim() === '') {
                                tabContentLines.push('');
                                i++; continue;
                            }
                            if (tabBaseIndent === -1) tabBaseIndent = nextIndent;
                            
                            if (nextIndent < tabBaseIndent) {
                                i--; // 回退
                                break;
                            }
                            tabContentLines.push(nextContentLine.substring(tabBaseIndent));
                            i++;
                        }
                        tabs.push({ title: tabTitle, content: tabContentLines.join('\n') });
                    }

                    // 渲染整组 Tabs
                    if (tabs.length > 0) {
                        const uniqueId = Math.random().toString(36).substr(2, 9);
                        let labelsHtml = '';
                        let panesHtml = '';
                        tabs.forEach((tab, idx) => {
                            const active = idx === 0 ? 'active' : '';
                            // 递归渲染 Tab 内部！
                            const tabInnerHtml = parseAndRender(tab.content);
                            labelsHtml += `<div class="tab-label ${active}" onclick="switchTab('${uniqueId}', ${idx})">${tab.title}</div>`;
                            panesHtml += `<div class="tab-content ${active}" data-idx="${idx}">${tabInnerHtml}</div>`;
                        });
                        resultHTML += `<div class="tab-group" id="tab-${uniqueId}"><div class="tab-labels">${labelsHtml}</div>${panesHtml}</div>`;
                    }

                } else {
                    buffer.push(line);
                }
            }
            flushBuffer();
            return resultHTML;
        }

        // 全局 Tab 切换函数
        window.switchTab = function(groupId, tabIdx) {
            const group = document.getElementById(`tab-${groupId}`);
            const labels = group.querySelectorAll('.tab-label');
            const contents = group.querySelectorAll('.tab-content');
            
            labels.forEach((l, i) => l.classList.toggle('active', i === tabIdx));
            contents.forEach((c, i) => c.classList.toggle('active', i === tabIdx));
        }

        // --- 3. 页面渲染逻辑 ---
        async function showDetail(id) {
            const art = allArticles.find(a => a.id == id);
            const container = document.getElementById('view-area');
            if (!art) return container.innerHTML = "<h1>404</h1>";

            // 使用我们强大的自定义渲染器
            const htmlContent = parseAndRender(art.md || '');

            container.innerHTML = `
                <div class="article-body">
                    <h1>${escapeHtml(art.title)}</h1>
                    <div style="font-size:0.9rem; color:#888; margin-bottom:30px">
                        ${new Date(art.created_at).toLocaleDateString()}
                        ${currentUser ? ` · <a href="javascript:Router.go('/article/${id}/edit')">编辑</a>` : ''}
                    </div>
                    <div id="md-root">${htmlContent}</div>
                </div>
            `;

            // 后置增强：数学公式和代码高亮
            const root = document.getElementById('md-root');
            renderMathInElement(root, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
            root.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            window.scrollTo(0,0);
        }

        // --- 4. 路由系统 ---
        const Router = {
            get() {
                const p = window.location.pathname;
                return { id: p.match(/\/article\/([^/]+)/)?.[1], isNew: p.endsWith('/new'), isEdit: p.endsWith('/edit') };
            },
            go(path) { window.history.pushState(null, '', path); this.handle(); },
            handle() {
                const p = this.get();
                if (p.isNew) renderEditor();
                else if (p.id && p.isEdit) renderEditor(p.id);
                else if (p.id) showDetail(p.id);
                else renderHome();
                renderSidebar();
            }
        };

        // --- 5. 辅助功能 ---
        async function renderHome() {
            const home = allArticles.find(a => a.id === 'home');
            if (home) showDetail('home');
            else document.getElementById('view-area').innerHTML = `
                <div class="article-body">
                    <h1>Wiki 已就绪</h1>
                    <p>数据库中没有 ID 为 <code>home</code> 的文章。</p>
                    ${currentUser ? `<button class="btn btn-primary" onclick="initHome()">初始化首页</button>` : ''}
                </div>`;
        }
        
        async function initHome() {
            await db.from('article').insert([{ id: 'home', title: '首页', md: '???+ note "欢迎"\n    欢迎来到 Wiki！点击左侧编辑开始。', created_at: new Date() }]);
            await fetchArticles(); Router.handle();
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const cur = Router.get().id;
            let h = `<div class="nav-header">Menu</div>`;
            h += `<div class="nav-item ${!cur?'active':''}" onclick="Router.go('/')">首页</div>`;
            if (currentUser) h += `<div class="nav-item" style="color:var(--primary)" onclick="Router.go('/article/new')">+ 新建文章</div>`;
            h += `<div class="nav-header">Articles</div>`;
            allArticles.filter(a => a.id !== 'home').forEach(a => {
                h += `<div class="nav-item ${cur==a.id?'active':''}" onclick="Router.go('/article/${a.id}')">${escapeHtml(a.title)}</div>`;
            });
            nav.innerHTML = h;
        }

        async function renderEditor(id=null) {
            if (!currentUser) return Router.go('/');
            const art = id ? allArticles.find(a => a.id == id) : { title: '', md: '' };
            document.getElementById('view-area').innerHTML = `
                <div class="editor-wrap">
                    <h2>${id?'编辑':'新建'}</h2>
                    <input id="ed-title" class="editor-input" value="${escapeHtml(art.title)}" placeholder="标题">
                    <textarea id="ed-md" class="editor-area" placeholder="Markdown content...">${art.md}</textarea>
                    <div style="margin-top:15px">
                        <button class="btn btn-primary" onclick="saveArt('${id||''}')">保存</button>
                        <button class="btn" onclick="Router.go('/')" style="background:#eee">取消</button>
                    </div>
                </div>`;
        }

        async function saveArt(id) {
            const title = document.getElementById('ed-title').value;
            const md = document.getElementById('ed-md').value;
            const finalId = id || Math.random().toString(36).substr(2, 12);
            const payload = { id: finalId, title, md, updated_at: new Date() };
            const { error } = id ? await db.from('article').update(payload).eq('id', id) : await db.from('article').insert([payload]);
            if (error) alert(error.message); else { await fetchArticles(); Router.go(finalId==='home'?'/':`/article/${finalId}`); }
        }

        async function fetchArticles() {
            const { data } = await db.from('article').select('*').order('created_at', { ascending: false });
            allArticles = data || [];
        }

        async function checkAuth() {
            const { data } = await db.auth.getSession();
            currentUser = data.session?.user;
            document.getElementById('auth-box').innerHTML = currentUser ? 
                `<span onclick="db.auth.signOut().then(()=>location.reload())" style="cursor:pointer;font-size:0.9rem">退出</span>` : 
                `<span onclick="login()" style="cursor:pointer;font-size:0.9rem">登录</span>`;
        }
        async function login() { const e=prompt("Email"), p=prompt("Password"); if(e&&p) await db.auth.signInWithPassword({email:e,password:p}).then(()=>location.reload()); }
        function escapeHtml(s) { const d = document.createElement('div'); d.innerText = s; return d.innerHTML; }

        window.onload = async () => { await checkAuth(); await fetchArticles(); Router.handle(); };
        window.onpopstate = () => Router.handle();
    </script>
</body>
</html>
