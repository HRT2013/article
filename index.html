<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRT's Wiki</title>
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1057417.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root { --md-primary: #3f51b5; --bg: #ffffff; --sidebar-bg: #f8f9fb; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg); color: #333; line-height: 1.6; }

        /* 布局 */
        .header { background: var(--md-primary); color: #fff; height: 56px; display: flex; align-items: center; padding: 0 24px; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { display: flex; margin-top: 56px; max-width: 1300px; margin-left: auto; margin-right: auto; min-height: calc(100vh - 56px); }
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid #eee; position: sticky; top: 56px; height: calc(100vh - 56px); overflow-y: auto; padding: 20px 0; }
        .main { flex: 1; padding: 40px; min-width: 0; }

        /* 侧边栏项 */
        .nav-item { display: block; padding: 10px 24px; color: #444; text-decoration: none; cursor: pointer; border-left: 4px solid transparent; transition: 0.2s; }
        .nav-item:hover { background: #eee; }
        .nav-item.active { background: #e8eaf6; color: var(--md-primary); border-left-color: var(--md-primary); font-weight: bold; }

        /* --- OI-Wiki 扩展组件样式 --- */
        /* 折叠框 */
        .admonition { margin: 1.5em 0; border: 1px solid #448aff; border-left-width: 0.3rem; border-radius: 4px; overflow: hidden; }
        .admonition-title { background: rgba(68,138,255,0.1); padding: 12px 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; }
        .admonition-title::after { content: "\f078"; font-family: "Font Awesome 6 Free"; margin-left: auto; transition: 0.3s; }
        .admonition.collapsed .admonition-title::after { transform: rotate(-90deg); }
        .admonition.collapsed .admonition-content { display: none; }
        .admonition-content { padding: 16px; background: #fff; }

        /* 选项卡 */
        .tab-container { margin: 1.5em 0; border: 1px solid #eee; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab-nav { display: flex; background: #f8f9fb; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tab-btn { padding: 12px 24px; border: none; background: none; cursor: pointer; font-size: 14px; color: #666; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab-btn.active { color: var(--md-primary); border-bottom-color: var(--md-primary); font-weight: bold; background: #fff; }
        .tab-pane { display: none; padding: 20px; }
        .tab-pane.active { display: block; }

        /* 代码与内容 */
        pre { background: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto; margin: 1em 0; }
        .article-content h1 { font-size: 2rem; margin-bottom: 0.5em; }
        .article-content h2 { margin: 1.5em 0 0.5em; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; }
        .btn-primary { background: var(--md-primary); color: white; }
        textarea.input-field { width: 100%; min-height: 500px; padding: 15px; font-family: monospace; margin-top: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <header class="header">
        <div style="font-weight: bold; cursor: pointer" onclick="Router.go('/')">HRT's Wiki</div>
        <div id="auth-ui" style="margin-left: auto"></div>
    </header>

    <div class="container">
        <aside class="sidebar" id="sidebar-nav"></aside>
        <main class="main" id="view-content"></main>
    </div>

    <script>
        // --- 1. 初始化 ---
        const CONFIG = {
            URL: 'https://qalinnggueysnsfrmoux.supabase.co',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhbGlubmdndWV5c25zZnJtb3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODUwNjgsImV4cCI6MjA4NjI2MTA2OH0.rlngJnOtXVs-Q1qXxN8iSrTCbjslJu0K_qouVsgOfj0'
        };
        const db = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
        let currentUser = null, allArticles = [];

        // --- 2. 核心：MkDocs 语法预处理器 ---
        // 我们改用“占位符法”：将块定义转换成带特殊 class 的 DIV，让内容留在里面
        function preProcessMd(md) {
            const lines = md.split('\n');
            let output = [];
            let stack = []; // 跟踪当前开启的 DIV 数量

            for (let line of lines) {
                const adm = line.match(/^(\?{3}\+?)\s+(\w+)\s+"([^"]+)"/);
                const tab = line.match(/^===\s+"([^"]+)"/);

                // 遇到定义，如果没缩进，说明是顶级块开始
                if (adm || tab) {
                    // 闭合之前的块（简单逻辑：顶级定义互斥）
                    while(stack.length > 0) { output.push('</div></div>'); stack.pop(); }

                    if (adm) {
                        output.push(`<div class="adm-placeholder" data-type="${adm[2]}" data-title="${adm[3]}">`);
                        stack.push('adm');
                    } else {
                        output.push(`<div class="tab-placeholder" data-title="${tab[1]}">`);
                        stack.push('tab');
                    }
                    continue;
                }

                // 闭合逻辑：遇到非空、非缩进的行，且当前在块内
                if (stack.length > 0 && line.trim().length > 0 && !line.startsWith(' ') && !line.startsWith('\t')) {
                    output.push('</div></div>');
                    stack.pop();
                }

                output.push(line);
            }
            while(stack.length > 0) { output.push('</div></div>'); stack.pop(); }
            return output.join('\n');
        }

        // --- 3. 核心：DOM 重组逻辑 ---
        function postProcessDOM(container) {
            // A. 处理折叠框
            container.querySelectorAll('.adm-placeholder').forEach(ph => {
                const type = ph.dataset.type;
                const title = ph.dataset.title;
                const wrapper = document.createElement('div');
                wrapper.className = `admonition ${type}`;
                wrapper.innerHTML = `<div class="admonition-title">${title}</div><div class="admonition-content"></div>`;
                
                // 移动内容
                const contentArea = wrapper.querySelector('.admonition-content');
                while(ph.firstChild) contentArea.appendChild(ph.firstChild);
                
                ph.replaceWith(wrapper);
                wrapper.querySelector('.admonition-title').onclick = () => wrapper.classList.toggle('collapsed');
            });

            // B. 处理选项卡
            const tabPlaceholders = Array.from(container.querySelectorAll('.tab-placeholder'));
            let currentGroup = [];
            
            tabPlaceholders.forEach((ph, i) => {
                currentGroup.push(ph);
                const next = ph.nextElementSibling;
                // 如果下一个不是占位符，说明这组 Tab 结束了
                if (!next || !next.classList.contains('tab-placeholder')) {
                    const tabContainer = document.createElement('div');
                    tabContainer.className = 'tab-container';
                    const nav = document.createElement('div');
                    nav.className = 'tab-nav';
                    tabContainer.appendChild(nav);

                    currentGroup.forEach((item, idx) => {
                        const title = item.dataset.title;
                        const btn = document.createElement('button');
                        btn.className = `tab-btn ${idx === 0 ? 'active' : ''}`;
                        btn.innerText = title;
                        
                        const pane = document.createElement('div');
                        pane.className = `tab-pane ${idx === 0 ? 'active' : ''}`;
                        while(item.firstChild) pane.appendChild(item.firstChild);

                        btn.onclick = () => {
                            tabContainer.querySelectorAll('.tab-btn, .tab-pane').forEach(el => el.classList.remove('active'));
                            btn.classList.add('active');
                            pane.classList.add('active');
                        };

                        nav.appendChild(btn);
                        tabContainer.appendChild(pane);
                    });
                    
                    currentGroup[0].parentNode.insertBefore(tabContainer, currentGroup[0]);
                    currentGroup.forEach(g => g.remove());
                    currentGroup = [];
                }
            });
        }

        // --- 4. 路由与显示 ---
        const Router = {
            get() {
                const path = window.location.pathname;
                return { id: path.match(/\/article\/([^/]+)/)?.[1], isNew: path.endsWith('/new'), isEdit: path.endsWith('/edit') };
            },
            go(path) { window.history.pushState(null, '', path); this.handle(); },
            handle() {
                const p = this.get();
                if (p.isNew) renderEditor();
                else if (p.id && p.isEdit) renderEditor(p.id);
                else if (p.id) renderDetail(p.id);
                else renderHome();
                updateSidebar();
            }
        };

        async function renderDetail(id) {
            const art = allArticles.find(a => a.id == id);
            if (!art) return;
            const target = document.getElementById('view-content');
            
            // 渲染流程：预处理 -> Marked解析 -> 后置处理DOM
            const processedHtml = marked.parse(preProcessMd(art.md || ''));
            target.innerHTML = `<div class="article-content"><h1>${art.title}</h1><div id="render-area">${processedHtml}</div></div>`;
            
            const renderArea = document.getElementById('render-area');
            postProcessDOM(renderArea);
            
            // 数学公式与高亮
            renderMathInElement(renderArea, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
            renderArea.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            window.scrollTo(0, 0);
        }

        async function renderHome() {
            const home = allArticles.find(a => a.id === 'home');
            home ? renderDetail('home') : document.getElementById('view-content').innerHTML = '<h1>欢迎使用 Wiki</h1><p>请在左侧选择或新建文章。</p>';
        }

        // --- 5. 编辑与保存 ---
        function renderEditor(id = null) {
            if (!currentUser) return Router.go('/');
            const art = id ? allArticles.find(a => a.id == id) : { title: '', md: '' };
            document.getElementById('view-content').innerHTML = `
                <h2>${id ? '编辑文章' : '新建文章'}</h2>
                <input id="ed-title" style="width:100%; padding:10px; margin:10px 0" value="${art.title}" placeholder="文章标题">
                <textarea id="ed-md" class="input-field" placeholder="支持 MkDocs 语法 (???+, ===) 和 LaTeX">$${art.md}</textarea>
                <div style="margin-top:10px">
                    <button class="btn btn-primary" onclick="saveArt('${id || ''}')">发布文章</button>
                    <button class="btn" onclick="Router.go('/')">取消</button>
                </div>`;
        }

        async function saveArt(id) {
            const title = document.getElementById('ed-title').value;
            const md = document.getElementById('ed-md').value;
            let finalId = id || Math.random().toString(36).substr(2, 12);
            const payload = { id: finalId, title, md, updated_at: new Date() };

            const { error } = id ? await db.from('article').update(payload).eq('id', id) : await db.from('article').insert([payload]);
            if (error) alert(error.message);
            else { await fetchArticles(); Router.go(finalId === 'home' ? '/' : `/article/${finalId}`); }
        }

        // --- 6. 基础系统 ---
        async function fetchArticles() {
            const { data } = await db.from('article').select('*').order('created_at', { ascending: false });
            allArticles = data || [];
        }

        function updateSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const cur = Router.get().id;
            let h = `<div class="nav-item ${!cur?'active':''}" onclick="Router.go('/')">首页</div>`;
            if (currentUser) h += `<div class="nav-item" style="color:green" onclick="Router.go('/article/new')">+ 新建文章</div>`;
            h += `<div style="padding:20px 24px 5px; font-size:12px; color:#999">所有文章</div>`;
            allArticles.filter(a => a.id !== 'home').forEach(a => {
                h += `<div class="nav-item ${cur==a.id?'active':''}" onclick="Router.go('/article/${a.id}')">${a.title}</div>`;
            });
            nav.innerHTML = h;
        }

        async function initAuth() {
            const { data } = await db.auth.getSession();
            currentUser = data.session?.user;
            document.getElementById('auth-ui').innerHTML = currentUser ? 
                `<button class="btn" onclick="db.auth.signOut().then(()=>location.reload())">退出</button>` : 
                `<button class="btn" onclick="login()">登录</button>`;
        }

        async function login() {
            const e = prompt("Email:"), p = prompt("Password:");
            if (e && p) await db.auth.signInWithPassword({email:e, password:p}).then(()=>location.reload());
        }

        window.onload = async () => { await initAuth(); await fetchArticles(); Router.handle(); };
        window.onpopstate = () => Router.handle();
    </script>
</body>
</html>
