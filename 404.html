<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="keywords" content="HRT HRT2013 HRT2013的个人主页">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRT's Blog</title>
    <script>
        document.title = 'Loding... 文章-HRT';
    </script>
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1057417.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <style>
        /* --- 全局基础样式 --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #f4f7f6; /* 背景色微调 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #2c3e50;
        }

        /* --- 页面布局容器 --- */
        .page-container {
            display: flex;
            max-width: 1300px;
            margin: 0 auto;
            gap: 30px;
            padding: 20px;
            min-height: 100vh;
        }

        /* --- 侧边栏样式 --- */
        .sidebar-wrapper {
            width: 280px;
            flex-shrink: 0;
        }

        .sidebar-content {
            background: white;
            border-radius: 12px;
            padding: 30px 20px;
            position: sticky;
            top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .sidebar-author img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 15px;
            border: 3px solid #f0f2f5;
        }

        .sidebar-author h3 {
            margin-bottom: 8px;
            font-size: 1.5rem;
        }

        .sidebar-author p {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
        }

        .sidebar-nav a {
            color: #2c3e50;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-nav a:hover {
            background: #f0f7ff;
            color: #3498db;
        }

        /* --- 主内容区域 --- */
        .main-content {
            flex-grow: 1;
            min-width: 0;
        }

        /* --- 文章居中渲染容器 --- */
        .article-detail-view {
            max-width: 850px; /* 限制宽度实现居中感 */
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        /* --- 列表卡片样式 --- */
        .article-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .article-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .article-title {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #2c3e50;
        }

        .article-meta {
            font-size: 0.85rem;
            color: #95a5a6;
            margin-bottom: 15px;
        }

        .article-content-preview {
            color: #555;
            line-height: 1.7;
            margin-bottom: 20px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- 按钮与交互 --- */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { opacity: 0.9; }

        /* --- Markdown 内容样式 --- */
        .article-content {
            line-height: 1.8;
            font-size: 17px;
            color: #333;
        }

        .article-content h1, .article-content h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin: 30px 0 20px;
        }

        .article-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 20px auto;
            display: block;
        }

        /* --- 响应式适配 --- */
        @media (max-width: 992px) {
            .page-container {
                flex-direction: column;
            }
            .sidebar-wrapper {
                width: 100%;
            }
            .sidebar-content {
                position: static;
            }
            .article-detail-view {
                padding: 20px;
            }
        }

        /* Supabase 原始样式保留 */
        .loading { text-align: center; padding: 50px; color: #999; }
        .loading i { animation: spin 1s linear infinite; font-size: 2rem; }
        @keyframes spin { from {transform:rotate(0deg)} to {transform:rotate(360deg)} }
        .tags-container { display: flex; gap: 8px; margin: 10px 0; }
        .tag { background: #eef2f7; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; color: #5d6d7e; }
        .user-info { position: fixed; top: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>

<body>
    <div id="nav"></div>

    <div class="page-container">
        <aside class="sidebar-wrapper">
            <div class="sidebar-content">
                <div class="sidebar-author">
                    <img src="https://cdn.luogu.com.cn/upload/usericon/1057417.png" alt="Avatar">
                    <h3>HRT</h3>
                    <p>专注技术分享与生活记录</p>
                </div>
                <nav class="sidebar-nav">
                    <a href="/article"><i class="fas fa-home"></i> 博客首页</a>
                    <a href="https://github.com/HRT2013" target="_blank"><i class="fab fa-github"></i> GitHub</a>
                    <a href="#"><i class="fas fa-user"></i> 关于我</a>
                </nav>
            </div>
        </aside>

        <main id="content" class="main-content"></main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://qalinnggueysnsfrmoux.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhbGlubmdndWV5c25zZnJtb3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODUwNjgsImV4cCI6MjA4NjI2MTA2OH0.rlngJnOtXVs-Q1qXxN8iSrTCbjslJu0K_qouVsgOfj0';
        var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;

        // 基础工具函数
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatDate(s) { return s ? new Date(s).toLocaleString('zh-CN') : '未知时间'; }
        function parseTags(s) { return s ? s.split(',').map(t => t.trim()) : []; }
        function truncateMarkdown(m) { return m.replace(/[#*`]/g, '').substring(0, 150) + '...'; }

        // 路由系统
        const router = {
            routes: {
                '/article': showArticleList,
                '/article/:id': showArticleDetail,
                '/article/new': showNewArticle,
                '/article/:id/edit': showEditArticle
            },
            async init() {
                window.addEventListener('popstate', () => this.handleRoute());
                await this.handleRoute();
            },
            async handleRoute() {
                let path = window.location.pathname;
                if (path.endsWith('/') && path.length > 1) path = path.slice(0, -1);
                
                for (const route in this.routes) {
                    const regex = new RegExp(`^${route.replace(/:\w+/g, '([^/]+)')}$`);
                    const match = path.match(regex);
                    if (match) {
                        const params = {};
                        const names = [...route.matchAll(/:(\w+)/g)].map(m => m[1]);
                        names.forEach((n, i) => params[n] = match[i+1]);
                        this.routes[route](params);
                        return;
                    }
                }
                showArticleList();
            },
            navigate(path) { window.location.href = path; }
        };

        // 列表页渲染
        async function showArticleList() {
            document.title = '文章列表 - HRT';
            const content = document.getElementById('content');
            content.innerHTML = `<div class="loading"><i class="fas fa-spinner"></i><p>加载中...</p></div>`;

            const { data: articles } = await supabase.from('article').select('*').order('created_at', { ascending: false });

            content.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h1>所有文章</h1>
                    ${currentUser ? `<button class="btn btn-success" onclick="router.navigate('/article/new')"><i class="fas fa-plus"></i> 新建文章</button>` : `<button class="btn btn-primary" onclick="showLoginPopup()"><i class="fas fa-lock"></i> 登录</button>`}
                </div>
                ${articles.map(a => `
                    <div class="article-card">
                        <h2 class="article-title">${escapeHtml(a.title)}</h2>
                        <div class="article-meta">创建于 ${formatDate(a.created_at)}</div>
                        <div class="article-content-preview">${truncateMarkdown(a.md || '')}</div>
                        <button class="btn btn-primary" onclick="router.navigate('/article/${a.id}')">阅读全文</button>
                    </div>
                `).join('')}
            `;
        }

        // 详情页渲染（关键：居中布局应用）
        async function showArticleDetail(params) {
            const content = document.getElementById('content');
            content.innerHTML = `<div class="loading"><i class="fas fa-spinner"></i></div>`;

            const { data: article } = await supabase.from('article').select('*').eq('id', params.id).single();
            if (!article) return;

            document.title = `${article.title} - HRT`;
            const tags = parseTags(article.tag);

            content.innerHTML = `
                <div class="article-detail-view">
                    <header style="margin-bottom: 30px; text-align: center;">
                        <h1 style="font-size: 2.5rem; margin-bottom: 15px;">${escapeHtml(article.title)}</h1>
                        <div class="article-meta">
                            <span><i class="far fa-calendar"></i> ${formatDate(article.created_at)}</span>
                            ${article.updated_at ? `<span> | 更新于 ${formatDate(article.updated_at)}</span>` : ''}
                        </div>
                        <div class="tags-container" style="justify-content: center;">
                            ${tags.map(t => `<span class="tag"># ${escapeHtml(t)}</span>`).join('')}
                        </div>
                    </header>
                    
                    <div id="md-render" class="article-content"></div>
                    
                    <hr style="margin: 40px 0; border: none; border-top: 1px solid #eee;">
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="router.navigate('/article')"><i class="fas fa-arrow-left"></i> 返回列表</button>
                        ${currentUser ? `<button class="btn btn-success" onclick="router.navigate('/article/${article.id}/edit')"><i class="fas fa-edit"></i> 编辑</button>` : ''}
                    </div>
                </div>
            `;
            renderMarkdownAndLaTeX(article.md || '', 'md-render');
        }

        // --- 核心功能补全（登录、Markdown渲染等） ---
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showAdminUI();
            }
        }

        function showAdminUI() {
            const ui = document.createElement('div');
            ui.className = 'user-info';
            ui.innerHTML = `<span><i class="fas fa-user-shield"></i> 管理员</span> <button class="logout-btn" onclick="logout()">登出</button>`;
            document.body.appendChild(ui);
        }

        async function logout() { await supabase.auth.signOut(); location.reload(); }

        function renderMarkdownAndLaTeX(md, id) {
            if (typeof marked === 'undefined') {
                loadScript('https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js', () => {
                    loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js', () => {
                        loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js', () => {
                            const html = marked.parse(md);
                            document.getElementById(id).innerHTML = html;
                            if (window.renderMathInElement) renderMathInElement(document.getElementById(id));
                            document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                        });
                    });
                });
            }
        }

        function loadScript(src, cb) { const s = document.createElement('script'); s.src = src; s.onload = cb; document.head.appendChild(s); }

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await router.init();
        });

        // 补全 showNewArticle 和 showEditArticle 占位（保持原有逻辑即可）
        function showNewArticle() { /* 同原代码 */ }
        function showEditArticle(p) { /* 同原代码 */ }
        function showLoginPopup() { /* 同原代码 */ }
    </script>
</body>
</html>
